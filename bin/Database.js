// Generated by CoffeeScript 1.4.0
(function() {
  var Database, EventEmitter, mysql;

  EventEmitter = require('events').EventEmitter;

  mysql = require('mysql');

  Database = new EventEmitter();

  Database.on('conectar', function(callback) {
    var conn;
    conn = mysql.createConnection({
      "host": DB_HOST,
      "user": DB_USER,
      "password": DB_PASS,
      "database": DB_NAME
    });
    conn.connect();
    return callback(conn);
  });

  Database.on('inserirQuery', function(conn, query, callback) {
    return conn.query(query, function(err, rows, fields) {
      if (err) {
        throw err;
      }
      return callback(rows);
    });
  });

  Database.on('/table/coisas/all', function(callback) {
    return Database.emit('conectar', function(conn) {
      var query;
      query = "SELECT * FROM `" + TABLE_COISAS + "` WHERE 1;";
      return Database.emit('inserirQuery', conn, query, function(rows, fields) {
        callback(rows);
        return conn.end();
      });
    });
  });

  Database.on('/table/coisas/mais-citadas', function(callback) {
    return Database.emit('conectar', function(conn) {
      var query;
      query = "SELECT `id`, `coisa`, `vezes_citada` FROM `" + TABLE_COISAS + "` ORDER BY `vezes_citada` DESC LIMIT 0, 42;";
      return Database.emit('inserirQuery', conn, query, function(rows, fields) {
        callback(rows);
        return conn.end();
      });
    });
  });

  Database.on('/table/coisas/id', function(id, callback) {
    return Database.emit('conectar', function(conn) {
      var query;
      query = "SELECT * FROM `" + TABLE_COISAS + "` WHERE `id` = " + id + ";";
      return Database.emit('inserirQuery', conn, query, function(rows, fields) {
        callback(rows);
        return conn.end();
      });
    });
  });

  Database.on('/table/coisas/insert', function(obj) {
    return Database.emit('conectar', function(conn) {
      return Database.emit('/table/coisas/search/iguais', obj.coisa, function() {
        return Database.emit('/table/coisas/update/add', obj.coisa);
      }, function() {
        var query;
        query = "INSERT INTO `" + TABLE_COISAS + "` VALUES('', '" + obj.coisa + "', '1', NOW(), NOW(), '" + (obj.user || '') + "');";
        return Database.emit('inserirQuery', conn, query, function(rows, fields) {
          return conn.end();
        });
      });
    });
  });

  Database.on('/table/coisas/search/iguais', function(coisa, fn_yes, fn_no) {
    return Database.emit('conectar', function(conn) {
      var query;
      query = "SELECT `coisa` FROM `" + TABLE_COISAS + "` WHERE `coisa`='" + coisa + "';";
      return Database.emit('inserirQuery', conn, query, function(rows, fields) {
        if (rows.length > 0) {
          fn_yes();
        } else {
          fn_no();
        }
        return conn.end();
      });
    });
  });

  Database.on('/table/coisas/search/vezes-citada', function(coisa, callback) {
    return Database.emit('conectar', function(conn) {
      var query;
      query = "SELECT `vezes_citada` FROM `" + TABLE_COISAS + "` WHERE `coisa`='" + coisa + "';";
      return Database.emit('inserirQuery', conn, query, function(rows, fields) {
        callback(rows[0]['vezes_citada']);
        return conn.end();
      });
    });
  });

  Database.on('/table/coisas/update/add', function(coisa) {
    return Database.emit('/table/coisas/search/vezes-citada', coisa, function(vezes_citada) {
      return Database.emit('conectar', function(conn) {
        var query, temp;
        temp = parseInt(vezes_citada, 10);
        query = "UPDATE `" + TABLE_COISAS + "` SET `vezes_citada`='" + (temp += 1) + "' WHERE `coisa`='" + coisa + "';";
        return Database.emit('inserirQuery', conn, query, function(rows, fields) {
          return conn.end();
        });
      });
    });
  });

  module.exports = Database;

}).call(this);
